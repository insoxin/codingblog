<!doctype html><html lang="zh-CN" prefix="og: http://ogp.me/ns#"><head><link rel="stylesheet" href="https://blog.isoyu.com/wp-content/cache/min/1/578739095e70499c641c867c0713cda9.css" data-minify="1" /><script src="https://blog.isoyu.com/wp-content/cache/min/1/97a4db92cef74f5536fa09e58ec5ba74.js" data-minify="1"></script> <meta charset="UTF-8"><meta name="author" content="姬长信"><meta name="viewport" content="width=device-width,height=device-height, initial-scale=1.0, user-scalable=no" /><meta name="apple-mobile-web-app-capable" content="yes"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="实现也就不到两百行，本文就一步步揭开这个方法背后的黑魔法。" /><meta name="keywords" content="" /><link rel="canonical" href="https://blog.isoyu.com/archives/fishhooktihuanchanshudeyuanli.html"/><meta property="og:type" content="article"/><meta property="article:published_time" content="2018-11-27"/><meta property="article:author" content="姬長信" /><meta property="article:published_first" content="姬長信,https://blog.isoyu.com/archives/fishhooktihuanchanshudeyuanli.html" /><title>Fishhook替换C函数的原理 - 姬長信</title><link rel="canonical" href="https://blog.isoyu.com/archives/fishhooktihuanchanshudeyuanli.html" /><meta property="og:locale" content="zh_CN" /><meta property="og:type" content="article" /><meta property="og:title" content="Fishhook替换C函数的原理 - 姬長信" /><meta property="og:description" content="Fishhook Fishhook是facebook出品的，可以用来Hook C函数的一个开源库。它的主要接口 &hellip;" /><meta property="og:url" content="https://blog.isoyu.com/archives/fishhooktihuanchanshudeyuanli.html" /><meta property="og:site_name" content="姬長信" /><meta property="article:section" content="源码" /><meta property="article:published_time" content="2018-11-27T11:10:42+08:00" /><meta name="twitter:card" content="summary_large_image" /><meta name="twitter:description" content="Fishhook Fishhook是facebook出品的，可以用来Hook C函数的一个开源库。它的主要接口 [&hellip;]" /><meta name="twitter:title" content="Fishhook替换C函数的原理 - 姬長信" /><meta name="twitter:image" content="https://img-blog.csdn.net/20171103121106950?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvSGVsbG9fSHdj/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" /> <script type='application/ld+json'>{"@context":"https://schema.org","@type":"Person","url":"https://blog.isoyu.com/","sameAs":[],"@id":"#person","name":"\u59ec\u9577\u4fe1"}</script> <script type='application/ld+json'>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https://blog.isoyu.com/","name":"Home"}},{"@type":"ListItem","position":2,"item":{"@id":"https://blog.isoyu.com/archives/fishhooktihuanchanshudeyuanli.html","name":"Fishhook\u66ff\u6362C\u51fd\u6570\u7684\u539f\u7406"}}]}</script> <link rel='stylesheet' id='colorphp-css'  href='https://blog.isoyu.com/wp-content/themes/INSO/includes/color.php?ver=5.1' type='text/css' media='all' /> <script type='text/javascript'>/* <![CDATA[ */ var CrayonSyntaxSettings = {"version":"_2.7.2_beta","is_admin":"0","ajaxurl":"https:\/\/blog.isoyu.com\/wp-admin\/admin-ajax.php","prefix":"crayon-","setting":"crayon-setting","selected":"crayon-setting-selected","changed":"crayon-setting-changed","special":"crayon-setting-special","orig_value":"data-orig-value","debug":""};
var CrayonSyntaxStrings = {"copy":"Press %s to Copy, %s to Paste","minimize":"Click To Expand Code"}; /* ]]> */</script> <link rel='https://api.w.org/' href='https://blog.isoyu.com/wp-json/' /><link rel="shortcut icon" href="https://blog.isoyu.com/wp-content/themes/INSO/images/favicon.jpg" /><link rel="apple-touch-icon" sizes="120*120" href="https://blog.isoyu.com/wp-content/themes/INSO/images/favicon.jpg" /><link rel="amphtml" href="https://blog.isoyu.com/archives/fishhooktihuanchanshudeyuanli.html/amp/"><style type="text/css" title="dynamic-css" class="options-output">body{background-color:transparent;background-repeat:repeat;background-size:inherit;background-attachment:fixed;background-position:center center;background-image:url(https://blog.isoyu.com/wp-content/themes/INSO/images/body.png)}.content-post{line-height:28px;font-weight:400;font-style:normal;color:#666;font-size:14px}.crumbs_shop{background-color:#fff;background-repeat:no-repeat;background-size:cover;background-attachment:scroll;background-position:center center;background-image:url(https://blog.isoyu.com/wp-content/themes/INSO/images/crumbs_shop.jpg)}.crumbs_page{background-color:transparent;background-repeat:no-repeat;background-size:cover;background-attachment:scroll;background-position:center center;background-image:url(https://blog.isoyu.com/wp-content/themes/INSO/images/crumbs_page.jpg)}</style></head><body class="post-template-default single single-post postid-5790 single-format-standard"><aside class="mobile_aside mobile_menu"><nav class="mobile-nav"><div class="mobile-menu"><ul id="menu-zhanshi" class="menu"><li id="menu-item-2455" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-2455"><a href="https://blog.isoyu.com">首页</a></li><li id="menu-item-2454" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-has-children menu-item-2454"><a href="#">展示</a><ul class="sub-menu"><li id="menu-item-2373" class="icon-emoticon-smile menu-item menu-item-type-custom menu-item-object-custom menu-item-has-children menu-item-2373"><a href="#">中文</a><ul class="sub-menu"><li id="menu-item-2372" class="fa fa-clone menu-item menu-item-type-custom menu-item-object-custom menu-item-2372"><a href="https://blog.isoyu.com/?variant=zh-hans">简体中文</a></li><li id="menu-item-2369" class="fa fa-exchange menu-item menu-item-type-custom menu-item-object-custom menu-item-2369"><a href="https://blog.isoyu.com/?variant=zh-hant">繁體中文</a></li></ul></li><li id="menu-item-2365" class="fa fa-language menu-item menu-item-type-custom menu-item-object-custom menu-item-2365"><a target="_blank" href="http://translate.baiducontent.com/transpage?query=blog.isoyu.com&#038;from=auto&#038;to=en&#038;source=url">English</a></li><li id="menu-item-2364" class="icon-speech menu-item menu-item-type-custom menu-item-object-custom menu-item-2364"><a target="_blank" href="https://blog.isoyu.com/amp-sitemap.html">简体中文(AMP版)</a></li></ul></li><li id="menu-item-2456" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-has-children menu-item-2456"><a href="#">分类</a><ul class="sub-menu"><li id="menu-item-2458" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-2458"><a href="https://blog.isoyu.com/dachumeng/">大厨梦</a></li><li id="menu-item-2460" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-2460"><a href="https://blog.isoyu.com/happy/">happy</a></li><li id="menu-item-2462" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-2462"><a href="https://blog.isoyu.com/jpg/">图片</a></li><li id="menu-item-2461" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-2461"><a href="https://blog.isoyu.com/a-diary/">日记</a></li><li id="menu-item-2464" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-2464"><a href="https://blog.isoyu.com/music/">音乐</a></li><li id="menu-item-2463" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-2463"><a href="https://blog.isoyu.com/video/">视频</a></li><li id="menu-item-2457" class="menu-item menu-item-type-taxonomy menu-item-object-category current-post-ancestor current-menu-parent current-post-parent menu-item-2457"><a href="https://blog.isoyu.com/source-code/">源码</a></li><li id="menu-item-2459" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-2459"><a href="https://blog.isoyu.com/miscellaneous/">杂类</a></li></ul></li><li id="menu-item-2466" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2466"><a href="https://blog.isoyu.com/archives.html">归档</a></li><li id="menu-item-2465" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2465"><a href="https://blog.isoyu.com/about-me.html">关于</a></li><li id="menu-item-2994" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-has-children menu-item-2994"><a href="#">实验室</a><ul class="sub-menu"><li id="menu-item-2467" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2467"><a href="https://blog.isoyu.com/inso.html">INSO</a></li><li id="menu-item-2992" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2992"><a href="https://blog.isoyu.com/coderender.html">CodeRender</a></li></ul></li><li id="menu-item-2468" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2468"><a href="https://blog.isoyu.com/links.html">友情链接</a></li></ul></div></nav></aside> <aseide class="mobile_aside mobile_user"><section class="login-reg"><section class="mobile_avatar"> <img src="https://blog.isoyu.com/wp-content/themes/INSO/images/favicon.jpg" alt="姬長信"> 大佬早！</section><ul><li> <a class="user-login" href="#login"> <i class="icon-login"></i> 登录 </a></li></ul></section> </aseide><section id="content-container"><div class="popup_bg"></div><header class="mobile_header"><section id="header_main" class="mheader_main"> <i class="icon-menu"></i> <i class="icon-user"></i><h1> <a href="https://blog.isoyu.com" class="logo" title="-姬長信"><img src="https://blog.isoyu.com/wp-content/themes/INSO/images/logo.jpg" alt="姬長信"></a></h1></section></header><section class="container wrapper"><section class="crumbs_wrap box triangle"><h3> 源码</h3><article class="crumbs"> <a itemprop="breadcrumb" href="https://blog.isoyu.com">首页</a>&nbsp;»&nbsp;<a itemprop="breadcrumb" href="https://blog.isoyu.com/archives.html">归档</a>&nbsp;»&nbsp;<a itemprop="breadcrumb" href="https://blog.isoyu.com/source-code/">源码</a>&nbsp;»&nbsp;<span class="current">Fishhook替换C函数的原理</span></article>  <script type="text/javascript">var dropdown = document.getElementById("cat");
		function onCatChange() {
            if ( dropdown.options[dropdown.selectedIndex].value != '-1' ) {
                                location.href = "https://blog.isoyu.com/?cat="+dropdown.options[dropdown.selectedIndex].value;
                            }
		}
		dropdown.onchange = onCatChange;</script> </section><section class="content"><section class="content-wrap"><article class="entry box triangle"><header class="post-head"><h2>Fishhook替换C函数的原理</h2><div class="postinfo"><div class="left"> <span class="author"><a href="https://blog.isoyu.com/archives/author/2/" title="投稿者"><img class="avatar" src="https://blog.isoyu.com/wp-content/themes/INSO/images/favicon.jpg" data-original="https://secure.gravatar.com/avatar/1e4978badf8dd182e405d55e9ece0cf2?s=120" alt="投稿者" />投稿者</a></span> <span class="category"><a href="https://blog.isoyu.com/source-code/" rel="category tag">源码</a></span> <span class="date">2018-11-27</span></div><div class="right"> <span class="view"><i class="icon-eye"></i>294</span></div></div></header><div class="ad ad-single"></div><div class="content-post"> <br /><h2 style="box-sizing: border-box; outline: 0px; margin: 8px 0px 16px; padding: 0px; font-size: 24px; color: rgb(79, 79, 79); line-height: 32px; word-wrap: break-word; font-family: -apple-system, " sf="" ui="" pingfang="" hiragino="" sans="" microsoft="" wenquanyi="" micro="" font-variant-ligatures:="" white-space:="" background-color:="">Fishhook</h2><p style="box-sizing: border-box; outline: 0px; margin-top: 0px; margin-bottom: 16px; padding: 0px; color: rgb(79, 79, 79); line-height: 26px; word-wrap: break-word; font-family: -apple-system, " sf="" ui="" pingfang="" hiragino="" sans="" microsoft="" wenquanyi="" micro="" font-variant-ligatures:="" white-space:="" background-color:=""><a href="https://blog.isoyu.com/go.php?url=https://github.com/facebook/fishhook"  rel="nofollow" target="_blank" style="box-sizing: border-box; outline: 0px; margin: 0px; padding: 0px; color: rgb(103, 149, 181); text-decoration-line: none; background-color: transparent; text-decoration-skip: ink; word-wrap: break-word;">Fishhook</a>是facebook出品的，可以用来Hook C函数的一个开源库。它的主要接口就一个：</p><section style="color: rgb(62, 62, 62); line-height: 1.6; letter-spacing: 0px; font-family: " helvetica="" hiragino="" sans="" microsoft=""><pre style="font-size: inherit; color: inherit; line-height: inherit; margin-top: 0px; margin-bottom: 0px; padding: 0px;"><code style="margin: 0px 2px; line-height: 18px; font-size: 14px; letter-spacing: 0px; font-family: Consolas, Inconsolata, Courier, monospace; border-radius: 0px; color: rgb(169, 183, 198); background: rgb(40, 43, 46); padding: 0.5em; display: block !important; word-wrap: normal !important; word-break: normal !important; overflow: auto !important;"><span class="hljs-class" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">struct</span>&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(165, 218, 45); word-wrap: inherit !important; word-break: inherit !important;">rebinding</span>&nbsp;{</span><br/>&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">const</span>&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">char</span>&nbsp;*name;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(128, 128, 128); word-wrap: inherit !important; word-break: inherit !important;">//字符串名称</span><br/>&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">void</span>&nbsp;*replacement;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(128, 128, 128); word-wrap: inherit !important; word-break: inherit !important;">//替换后的方法</span><br/>&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">void</span>&nbsp;**replaced;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(128, 128, 128); word-wrap: inherit !important; word-break: inherit !important;">//原始的方法（通常要存储下来，在替换后的方法里调用）</span><br/>};<br/><br/><span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(128, 128, 128); word-wrap: inherit !important; word-break: inherit !important;">//两个参数分别是rebinding结构体数组，以及数组的长度</span><br/><span class="hljs-function" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;">int</span>&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(165, 218, 45); word-wrap: inherit !important; word-break: inherit !important;">rebind_symbols</span><span class="hljs-params" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(255, 152, 35); word-wrap: inherit !important; word-break: inherit !important;">(struct&nbsp;rebinding&nbsp;rebindings[],&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">size_t</span>&nbsp;rebindings_nel)</span></span>;<br/></code></pre></section><p><span style="color: rgb(79, 79, 79); font-family: -apple-system, " sf="" ui="" pingfang="" hiragino="" sans="" microsoft="" wenquanyi="" micro="" font-variant-ligatures:="" white-space:="" background-color:="">实现也就不到两百行，本文就一步步揭开这个方法背后的黑魔法。</span></p><p><span style="color: rgb(79, 79, 79); font-family: -apple-system, " sf="" ui="" pingfang="" hiragino="" sans="" microsoft="" wenquanyi="" micro="" font-variant-ligatures:="" white-space:="" background-color:=""><span style="color: rgb(153, 153, 153); font-family: -apple-system, " sf="" ui="" pingfang="" hiragino="" sans="" microsoft="" wenquanyi="" micro="" font-size:="" font-variant-ligatures:="" white-space:="" background-color:="">如果读者对dyld和Mach-O两个名词感到陌生，建议先看我的上一篇文章《</span><a href="https://blog.isoyu.com/go.php?url=http://blog.csdn.net/hello_hwc/article/details/78317863"  rel="nofollow" target="_blank" style="box-sizing: border-box; outline: 0px; margin: 0px; padding: 0px; color: rgb(103, 149, 181); text-decoration-line: none; background-color: rgb(238, 240, 244); text-decoration-skip: ink; word-wrap: break-word; font-family: -apple-system, " sf="" ui="" pingfang="" hiragino="" sans="" microsoft="" wenquanyi="" micro="" font-size:="" font-variant-ligatures:="" white-space:="">深入理解iOS App的启动过程</a><span style="color: rgb(153, 153, 153); font-family: -apple-system, " sf="" ui="" pingfang="" hiragino="" sans="" microsoft="" wenquanyi="" micro="" font-size:="" font-variant-ligatures:="" white-space:="" background-color:="">》</span></span></p></p><h2 style="box-sizing: border-box; outline: 0px; margin: 8px 0px 16px; padding: 0px; font-size: 24px; color: rgb(79, 79, 79); line-height: 32px; word-wrap: break-word; font-family: -apple-system, " sf="" ui="" pingfang="" hiragino="" sans="" microsoft="" wenquanyi="" micro="" font-variant-ligatures:="" white-space:="" background-color:="">原理</h2><p style="box-sizing: border-box; outline: 0px; margin-top: 0px; margin-bottom: 16px; padding: 0px; color: rgb(79, 79, 79); line-height: 26px; word-wrap: break-word; font-family: -apple-system, " sf="" ui="" pingfang="" hiragino="" sans="" microsoft="" wenquanyi="" micro="" font-variant-ligatures:="" white-space:="" background-color:="">在讲解具体过程之前，首先介绍一个概念：<a href="https://blog.isoyu.com/go.php?url=https://en.wikipedia.org/wiki/Position-independent_code"  rel="nofollow" target="_blank" style="box-sizing: border-box; outline: 0px; margin: 0px; padding: 0px; color: rgb(103, 149, 181); text-decoration-line: none; background-color: transparent; text-decoration-skip: ink; word-wrap: break-word;">PIC</a>(Position Indepent Code)，位置无关代码。</p></p><p>使用PIC的Mach-O文件，在引用符号（比如printf）的时候，并不是直接去找到符号的地址（编译期并不知道运行时printf的函数地址），而是通过在__DATA Segment上创建一个指针，等到启动的时候，dyld动态的去做绑定（bind），这样__DATA Segment上的指针就指向了printf的实现。</p><p></p><p>知道这一点很关键，因为这是fishhook能够工作的核心原理，finshhook就是通过rebind_symbols修改__DATASegment上的符号指针指向，来动态的hook C函数。</p><p></p><ul style="list-style-type: disc;"><li><p>在__DATA段中，有两个Sections和动态符号绑定有关：</p></li><li><p>__nl_symbol_ptr 存储了non-lazily绑定的符号，这些符号在mach-o加载的时候绑定。</p></li><li><p>__la_symbol_ptr 存储了lazy绑定的符号（方法），这些方法在第一调用的时候，由dyld_stub_binder来绑定，所以你会看到，每个mach-o的non-lazily绑定符号都有dyld_stub_binder。</p></li></ul><p></p><p><span style="color: rgb(79, 79, 79); font-family: -apple-system, " sf="" ui="" pingfang="" hiragino="" sans="" microsoft="" wenquanyi="" micro="" font-variant-ligatures:="" white-space:="" background-color:=""></span></p><p>通过dyld相关的API，我们可以很容易的访问到这些Symbols指针，但是并不知道这些指针具体代表哪种函数。</p><p>所以，要解决的问题就是找到这些指针代表的字符串，和当前的要替换的进行比较，如果一样替换当前指针的实现即可。</p><p>接下来我们就来看看，如何通过一系列操作来找到这些指针代表的字符串。</p><p style="box-sizing: border-box; outline: 0px; margin: 8px 0px 16px; padding: 0px; font-size: 22px; color: rgb(79, 79, 79); line-height: 30px; word-wrap: break-word; font-family: -apple-system, " sf="" ui="" pingfang="" hiragino="" sans="" microsoft="" wenquanyi="" micro="" font-variant-ligatures:="" white-space:="" background-color:="">准备工作</p><p>新建一个iOS单页面工程，添加一个C函数,然后，编译生成.app文件，在.app文件中获取可执行文件，用MachOView打开，选中__la_symbol_ptr，接下来我们就看看如何找到objc_msgSend的符号。</p><p><img data-original="https://img-blog.csdn.net/20171103121106950?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvSGVsbG9fSHdj/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" src="https://blog.isoyu.com/wp-content/themes/INSO/images/post_loading.gif" style="box-sizing: border-box; outline: 0px; margin: 24px 0px; padding: 0px; border-style: none; max-width: 100%; word-wrap: break-word; cursor: zoom-in; color: rgb(79, 79, 79); font-family: -apple-system, " sf="" ui="" pingfang="" hiragino="" sans="" microsoft="" wenquanyi="" micro="" font-variant-ligatures:="" white-space:="" background-color:=""/></p><p><span style="color: rgb(79, 79, 79); font-family: -apple-system, " sf="" ui="" pingfang="" hiragino="" sans="" microsoft="" wenquanyi="" micro="" font-variant-ligatures:="" white-space:="" background-color:=""></span></p><h3 style="box-sizing: border-box; outline: 0px; margin: 8px 0px 16px; padding: 0px; font-size: 22px; color: rgb(79, 79, 79); line-height: 30px; word-wrap: break-word; font-family: -apple-system, " sf="" ui="" pingfang="" hiragino="" sans="" microsoft="" wenquanyi="" micro="" font-variant-ligatures:="" white-space:="" background-color:="">遍历存储Symbols的两个Section</h3><p style="box-sizing: border-box; outline: 0px; margin-top: 0px; margin-bottom: 16px; padding: 0px; color: rgb(79, 79, 79); line-height: 26px; word-wrap: break-word; font-family: -apple-system, " sf="" ui="" pingfang="" hiragino="" sans="" microsoft="" wenquanyi="" micro="" font-variant-ligatures:="" white-space:="" background-color:="">其中，表示Section Header的数据结构如下，这里我们用到的是reserved1字段。由于是遍历，所以我们知道index，比如1061</p><section style="color: rgb(62, 62, 62); line-height: 1.6; letter-spacing: 0px; font-family: " helvetica="" hiragino="" sans="" microsoft=""><pre style="font-size: inherit; color: inherit; line-height: inherit; margin-top: 0px; margin-bottom: 0px; padding: 0px;"><code style="margin: 0px 2px; line-height: 18px; font-size: 14px; letter-spacing: 0px; font-family: Consolas, Inconsolata, Courier, monospace; border-radius: 0px; color: rgb(169, 183, 198); background: rgb(40, 43, 46); padding: 0.5em; display: block !important; word-wrap: normal !important; word-break: normal !important; overflow: auto !important;"><span class="hljs-class" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">struct</span>&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(165, 218, 45); word-wrap: inherit !important; word-break: inherit !important;">section</span>&nbsp;{</span>&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(128, 128, 128); word-wrap: inherit !important; word-break: inherit !important;">/*&nbsp;for&nbsp;32-bit&nbsp;architectures&nbsp;*/</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">char</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sectname[<span class="hljs-number" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(174, 135, 250); word-wrap: inherit !important; word-break: inherit !important;">16</span>];&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(128, 128, 128); word-wrap: inherit !important; word-break: inherit !important;">/*&nbsp;name&nbsp;of&nbsp;this&nbsp;section&nbsp;*/</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">char</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;segname[<span class="hljs-number" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(174, 135, 250); word-wrap: inherit !important; word-break: inherit !important;">16</span>];&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(128, 128, 128); word-wrap: inherit !important; word-break: inherit !important;">/*&nbsp;segment&nbsp;this&nbsp;section&nbsp;goes&nbsp;in&nbsp;*/</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">uint32_t</span>&nbsp;&nbsp;&nbsp;&nbsp;addr;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(128, 128, 128); word-wrap: inherit !important; word-break: inherit !important;">/*&nbsp;memory&nbsp;address&nbsp;of&nbsp;this&nbsp;section&nbsp;*/</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">uint32_t</span>&nbsp;&nbsp;&nbsp;&nbsp;size;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(128, 128, 128); word-wrap: inherit !important; word-break: inherit !important;">/*&nbsp;size&nbsp;in&nbsp;bytes&nbsp;of&nbsp;this&nbsp;section&nbsp;*/</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">uint32_t</span>&nbsp;&nbsp;&nbsp;&nbsp;offset;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(128, 128, 128); word-wrap: inherit !important; word-break: inherit !important;">/*&nbsp;file&nbsp;offset&nbsp;of&nbsp;this&nbsp;section&nbsp;*/</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">uint32_t</span>&nbsp;&nbsp;&nbsp;&nbsp;align;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(128, 128, 128); word-wrap: inherit !important; word-break: inherit !important;">/*&nbsp;section&nbsp;alignment&nbsp;(power&nbsp;of&nbsp;2)&nbsp;*/</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">uint32_t</span>&nbsp;&nbsp;&nbsp;&nbsp;reloff;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(128, 128, 128); word-wrap: inherit !important; word-break: inherit !important;">/*&nbsp;file&nbsp;offset&nbsp;of&nbsp;relocation&nbsp;entries&nbsp;*/</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">uint32_t</span>&nbsp;&nbsp;&nbsp;&nbsp;nreloc;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(128, 128, 128); word-wrap: inherit !important; word-break: inherit !important;">/*&nbsp;number&nbsp;of&nbsp;relocation&nbsp;entries&nbsp;*/</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">uint32_t</span>&nbsp;&nbsp;&nbsp;&nbsp;flags;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(128, 128, 128); word-wrap: inherit !important; word-break: inherit !important;">/*&nbsp;flags&nbsp;(section&nbsp;type&nbsp;and&nbsp;attributes)*/</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">uint32_t</span>&nbsp;&nbsp;&nbsp;&nbsp;reserved1;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(128, 128, 128); word-wrap: inherit !important; word-break: inherit !important;">/*&nbsp;reserved&nbsp;(for&nbsp;offset&nbsp;or&nbsp;index)&nbsp;*/</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">uint32_t</span>&nbsp;&nbsp;&nbsp;&nbsp;reserved2;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(128, 128, 128); word-wrap: inherit !important; word-break: inherit !important;">/*&nbsp;reserved&nbsp;(for&nbsp;count&nbsp;or&nbsp;sizeof)&nbsp;*/</span><br/>};<br/></code></pre></section><p><strong><span style="white-space: nowrap;">读取Indirect Symbol Table</span></strong></p><p><span style="white-space: nowrap;">Indirect Symbol Table位于__LINKEDIT段，存储了间接寻址Symbol Table的数组下标，数据类型为unit31_t。</span></p><p><span style="white-space: nowrap;">通过上一步得到的index+reversed1为下标，我们访问Indirect Symbol Table，找到objc_msgSend的信息：</span></p><p><span style="color: rgb(79, 79, 79); font-family: -apple-system, " sf="" ui="" pingfang="" hiragino="" sans="" microsoft="" wenquanyi="" micro="" font-variant-ligatures:="" white-space:="" background-color:=""><img data-original="https://img-blog.csdn.net/20171103121529562?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvSGVsbG9fSHdj/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" src="https://blog.isoyu.com/wp-content/themes/INSO/images/post_loading.gif" style="box-sizing: border-box; outline: 0px; margin: 24px 0px; padding: 0px; border-style: none; max-width: 100%; word-wrap: break-word; cursor: zoom-in; color: rgb(79, 79, 79); font-family: -apple-system, " sf="" ui="" pingfang="" hiragino="" sans="" microsoft="" wenquanyi="" micro="" font-variant-ligatures:="" white-space:="" background-color:=""/></span></p></p><p><span style="white-space: nowrap;">这里可以看到，图中选中的一行中，Data是00000063，换算成16进制就是99。</span></p><p><strong><span style="white-space: nowrap;">读取Symbol Table</span></strong></p><p><span style="white-space: nowrap;">Symbol Table位于__LINKEDIT段，存储了符号的信息，数据类型为nlist。</span></p><p><span style="white-space: nowrap;">通过Indirect Symbol Table，我们知道objc_msgSend在Symbol Table的下标是99。</span></p><p><span style="color: rgb(79, 79, 79); font-family: -apple-system, " sf="" ui="" pingfang="" hiragino="" sans="" microsoft="" wenquanyi="" micro="" font-variant-ligatures:="" white-space:="" background-color:=""><img data-original="https://img-blog.csdn.net/20171103122126147?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvSGVsbG9fSHdj/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" src="https://blog.isoyu.com/wp-content/themes/INSO/images/post_loading.gif" style="box-sizing: border-box; outline: 0px; margin: 24px 0px; padding: 0px; border-style: none; max-width: 100%; word-wrap: break-word; cursor: zoom-in; color: rgb(79, 79, 79); font-family: -apple-system, " sf="" ui="" pingfang="" hiragino="" sans="" microsoft="" wenquanyi="" micro="" font-variant-ligatures:="" white-space:="" background-color:=""/><code source="" code="" dejavu="" sans="" ubuntu="" anonymous="" droid="" pingfang="" microsoft="" font-size:="" line-height:="" color:="" background-color:="" border-radius:="" word-wrap:="" font-variant-ligatures:="" white-space:="" style="box-sizing: border-box; outline: 0px; margin: 0px; padding: 2px 4px;">nlist</code><span sf="" ui="" pingfang="" hiragino="" sans="" microsoft="" wenquanyi="" micro="" font-variant-ligatures:="" white-space:="" background-color:="">的数据结构如下：</span></span></p></p><section style="color: rgb(62, 62, 62); line-height: 1.6; letter-spacing: 0px; font-family: " helvetica="" hiragino="" sans="" microsoft=""><pre style="font-size: inherit; color: inherit; line-height: inherit; margin-top: 0px; margin-bottom: 0px; padding: 0px;"><code style="margin: 0px 2px; line-height: 18px; font-size: 14px; letter-spacing: 0px; font-family: Consolas, Inconsolata, Courier, monospace; border-radius: 0px; color: rgb(169, 183, 198); background: rgb(40, 43, 46); padding: 0.5em; display: block !important; word-wrap: normal !important; word-break: normal !important; overflow: auto !important;"><span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(128, 128, 128); word-wrap: inherit !important; word-break: inherit !important;">//32位</span><br/><span class="hljs-class" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">struct</span>&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(165, 218, 45); word-wrap: inherit !important; word-break: inherit !important;">nlist</span>&nbsp;{</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">union</span>&nbsp;{<br/><span class="hljs-meta" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(91, 218, 237); word-wrap: inherit !important; word-break: inherit !important;">#<span class="hljs-meta-keyword" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;">ifndef</span>&nbsp;__LP64__</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">char</span>&nbsp;*n_name;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(128, 128, 128); word-wrap: inherit !important; word-break: inherit !important;">/*&nbsp;for&nbsp;use&nbsp;when&nbsp;in-core&nbsp;*/</span><br/><span class="hljs-meta" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(91, 218, 237); word-wrap: inherit !important; word-break: inherit !important;">#<span class="hljs-meta-keyword" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;">endif</span></span><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">uint32_t</span>&nbsp;n_strx;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(128, 128, 128); word-wrap: inherit !important; word-break: inherit !important;">/*&nbsp;index&nbsp;into&nbsp;the&nbsp;string&nbsp;table&nbsp;*/</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;n_un;<br/>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">uint8_t</span>&nbsp;n_type;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(128, 128, 128); word-wrap: inherit !important; word-break: inherit !important;">/*&nbsp;type&nbsp;flag,&nbsp;see&nbsp;below&nbsp;*/</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">uint8_t</span>&nbsp;n_sect;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(128, 128, 128); word-wrap: inherit !important; word-break: inherit !important;">/*&nbsp;section&nbsp;number&nbsp;or&nbsp;NO_SECT&nbsp;*/</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">int16_t</span>&nbsp;n_desc;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(128, 128, 128); word-wrap: inherit !important; word-break: inherit !important;">/*&nbsp;see&nbsp;<mach-o stab.h="">&nbsp;*/</mach-o></span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">uint32_t</span>&nbsp;n_value;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(128, 128, 128); word-wrap: inherit !important; word-break: inherit !important;">/*&nbsp;value&nbsp;of&nbsp;this&nbsp;symbol&nbsp;(or&nbsp;stab&nbsp;offset)&nbsp;*/</span><br/>};<br/><span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(128, 128, 128); word-wrap: inherit !important; word-break: inherit !important;">//64位</span><br/><span class="hljs-class" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">struct</span>&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(165, 218, 45); word-wrap: inherit !important; word-break: inherit !important;">nlist_64</span>&nbsp;{</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">union</span>&nbsp;{<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">uint32_t</span>&nbsp;&nbsp;n_strx;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(128, 128, 128); word-wrap: inherit !important; word-break: inherit !important;">/*&nbsp;index&nbsp;into&nbsp;the&nbsp;string&nbsp;table&nbsp;*/</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;n_un;<br/>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">uint8_t</span>&nbsp;n_type;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(128, 128, 128); word-wrap: inherit !important; word-break: inherit !important;">/*&nbsp;type&nbsp;flag,&nbsp;see&nbsp;below&nbsp;*/</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">uint8_t</span>&nbsp;n_sect;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(128, 128, 128); word-wrap: inherit !important; word-break: inherit !important;">/*&nbsp;section&nbsp;number&nbsp;or&nbsp;NO_SECT&nbsp;*/</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">uint16_t</span>&nbsp;n_desc;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(128, 128, 128); word-wrap: inherit !important; word-break: inherit !important;">/*&nbsp;see&nbsp;<mach-o stab.h="">&nbsp;*/</mach-o></span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">uint64_t</span>&nbsp;n_value;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(128, 128, 128); word-wrap: inherit !important; word-break: inherit !important;">/*&nbsp;value&nbsp;of&nbsp;this&nbsp;symbol&nbsp;(or&nbsp;stab&nbsp;offset)&nbsp;*/</span><br/>};<br/></code></pre></section><p style="box-sizing: border-box; outline: 0px; margin-top: 0px; margin-bottom: 16px; padding: 0px; color: rgb(79, 79, 79); line-height: 26px; word-wrap: break-word; font-family: -apple-system, " sf="" ui="" pingfang="" hiragino="" sans="" microsoft="" wenquanyi="" micro="" font-variant-ligatures:="" white-space:="" background-color:="">通过这个数据结构，我们可以获取到<code style="box-sizing: border-box; outline: 0px; margin: 0px; padding: 2px 4px; font-family: " source="" code="" dejavu="" sans="" ubuntu="" anonymous="" droid="" pingfang="" microsoft="" font-size:="" line-height:="" color:="" background-color:="" border-radius:="" word-wrap:="">uint32_t n_strx;</code>，这个下标将在下一步用到。</p><h3 style="box-sizing: border-box; outline: 0px; margin: 8px 0px 16px; padding: 0px; font-size: 22px; color: rgb(79, 79, 79); line-height: 30px; word-wrap: break-word; font-family: -apple-system, " sf="" ui="" pingfang="" hiragino="" sans="" microsoft="" wenquanyi="" micro="" font-variant-ligatures:="" white-space:="" background-color:=""><a style="box-sizing: border-box; outline: 0px; margin: 0px; padding: 0px; color: rgb(78, 161, 219); cursor: pointer; background-color: transparent; text-decoration-skip: ink; word-wrap: break-word;" name="t6"></a>读取String Table</h3><p style="box-sizing: border-box; outline: 0px; margin-top: 0px; margin-bottom: 16px; padding: 0px; color: rgb(79, 79, 79); line-height: 26px; word-wrap: break-word; font-family: -apple-system, " sf="" ui="" pingfang="" hiragino="" sans="" microsoft="" wenquanyi="" micro="" font-variant-ligatures:="" white-space:="" background-color:="">根据上一步获取到偏移量+String Table的基础偏移量，我们就能知道这个符号对应的字符串名称了。</p><p><img data-original="https://img-blog.csdn.net/20171103123033892?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvSGVsbG9fSHdj/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" src="https://blog.isoyu.com/wp-content/themes/INSO/images/post_loading.gif" style="box-sizing: border-box; outline: 0px; margin: 24px 0px; padding: 0px; border-style: none; max-width: 100%; word-wrap: break-word; cursor: zoom-in; color: rgb(79, 79, 79); font-family: -apple-system, " sf="" ui="" pingfang="" hiragino="" sans="" microsoft="" wenquanyi="" micro="" font-variant-ligatures:="" white-space:="" background-color:=""/><span style="color: rgb(79, 79, 79); font-family: -apple-system, " sf="" ui="" pingfang="" hiragino="" sans="" microsoft="" wenquanyi="" micro="" font-variant-ligatures:="" white-space:="" background-color:=""></span></p></p><h3 style="box-sizing: border-box; outline: 0px; margin: 8px 0px 16px; padding: 0px; font-size: 22px; color: rgb(79, 79, 79); line-height: 30px; word-wrap: break-word; font-family: -apple-system, " sf="" ui="" pingfang="" hiragino="" sans="" microsoft="" wenquanyi="" micro="" font-variant-ligatures:="" white-space:="" background-color:="">小结</h3><p style="box-sizing: border-box; outline: 0px; margin-top: 0px; margin-bottom: 16px; padding: 0px; color: rgb(79, 79, 79); line-height: 26px; word-wrap: break-word; font-family: -apple-system, " sf="" ui="" pingfang="" hiragino="" sans="" microsoft="" wenquanyi="" micro="" font-variant-ligatures:="" white-space:="" background-color:="">上述的四个步骤，总结一下如图（图片来自官方）：</p><p><img data-original="https://img-blog.csdn.net/20171103123324323?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvSGVsbG9fSHdj/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" src="https://blog.isoyu.com/wp-content/themes/INSO/images/post_loading.gif" style="box-sizing: border-box; outline: 0px; margin: 24px 0px; padding: 0px; border-style: none; max-width: 100%; word-wrap: break-word; cursor: zoom-in; color: rgb(79, 79, 79); font-family: -apple-system, " sf="" ui="" pingfang="" hiragino="" sans="" microsoft="" wenquanyi="" micro="" font-variant-ligatures:="" white-space:="" background-color:=""/></p></p><p style="box-sizing: border-box; outline: 0px; margin-top: 0px; margin-bottom: 16px; padding: 0px; color: rgb(79, 79, 79); line-height: 26px; word-wrap: break-word; font-family: -apple-system, " sf="" ui="" pingfang="" hiragino="" sans="" microsoft="" wenquanyi="" micro="" font-variant-ligatures:="" white-space:="" background-color:="">到这里，我们只要遍历所有的<code style="box-sizing: border-box; outline: 0px; margin: 0px; padding: 2px 4px; font-family: " source="" code="" dejavu="" sans="" ubuntu="" anonymous="" droid="" pingfang="" microsoft="" font-size:="" line-height:="" color:="" background-color:="" border-radius:="" word-wrap:="">__nl_symbol_ptr</code>和<code style="box-sizing: border-box; outline: 0px; margin: 0px; padding: 2px 4px; font-family: " source="" code="" dejavu="" sans="" ubuntu="" anonymous="" droid="" pingfang="" microsoft="" font-size:="" line-height:="" color:="" background-color:="" border-radius:="" word-wrap:="">__la_symbol_ptr</code>中的指针，就能够获得到其对应的字符串，也就是说，这是一个遍历匹配的过程。</p><h3 style="box-sizing: border-box; outline: 0px; margin: 8px 0px 16px; padding: 0px; font-size: 22px; color: rgb(79, 79, 79); line-height: 30px; word-wrap: break-word; font-family: -apple-system, " sf="" ui="" pingfang="" hiragino="" sans="" microsoft="" wenquanyi="" micro="" font-variant-ligatures:="" white-space:="" background-color:=""><a style="box-sizing: border-box; outline: 0px; margin: 0px; padding: 0px; color: rgb(78, 161, 219); cursor: pointer; background-color: transparent; text-decoration-skip: ink; word-wrap: break-word;" name="t8"></a>何时绑定</h3><p style="box-sizing: border-box; outline: 0px; margin-top: 0px; margin-bottom: 16px; padding: 0px; color: rgb(79, 79, 79); line-height: 26px; word-wrap: break-word; font-family: -apple-system, " sf="" ui="" pingfang="" hiragino="" sans="" microsoft="" wenquanyi="" micro="" font-variant-ligatures:="" white-space:="" background-color:="">利用dyld相关接口，我们可以注册image装载的监听方法：</p><section style="color: rgb(62, 62, 62); line-height: 1.6; letter-spacing: 0px; font-family: " helvetica="" hiragino="" sans="" microsoft=""><pre style="font-size: inherit; color: inherit; line-height: inherit; margin-top: 0px; margin-bottom: 0px; padding: 0px;"><code style="margin: 0px 2px; line-height: 18px; font-size: 14px; letter-spacing: 0px; font-family: Consolas, Inconsolata, Courier, monospace; border-radius: 0px; color: rgb(169, 183, 198); background: rgb(40, 43, 46); padding: 0.5em; display: block !important; word-wrap: normal !important; word-break: normal !important; overflow: auto !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">extern</span>&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">void</span>&nbsp;_dyld_register_func_for_add_image(<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">void</span>&nbsp;(*func)(<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">const</span>&nbsp;struct&nbsp;mach_header*&nbsp;mh,&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">intptr_t</span>&nbsp;vmaddr_slide));<br/></code></pre></section><p><span style="white-space: normal; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; outline: 0px; margin: 0px; padding: 0px; font-weight: 700; word-wrap: break-word; color: rgb(153, 153, 153); font-family: -apple-system, " sf="" ui="" pingfang="" hiragino="" sans="" microsoft="" wenquanyi="" micro="" font-size:="" font-variant-ligatures:="" white-space:="" background-color:="">调用<code style="box-sizing: border-box; outline: 0px; margin: 0px; padding: 2px 4px; font-family: " source="" code="" dejavu="" sans="" ubuntu="" anonymous="" droid="" pingfang="" microsoft="" line-height:="" color:="" background-color:="" border-radius:="" word-wrap:="">_dyld_register_func_for_add_image</code>注册监听方法后，当前已经装载的image(动态库等)会立刻触发回调，之后的image会在装载的时候触发回调。dyld在装载的时候，会对符号进行bind，而fishhook则会在回调函数中进行rebind。</span></span></p><p><span style="color: rgb(79, 79, 79); font-family: -apple-system, " sf="" ui="" pingfang="" hiragino="" sans="" microsoft="" wenquanyi="" micro="" font-variant-ligatures:="" white-space:="" background-color:=""></span></p><h3 style="box-sizing: border-box; outline: 0px; margin: 8px 0px 16px; padding: 0px; font-size: 22px; color: rgb(79, 79, 79); line-height: 30px; word-wrap: break-word; font-family: -apple-system, " sf="" ui="" pingfang="" hiragino="" sans="" microsoft="" wenquanyi="" micro="" font-variant-ligatures:="" white-space:="" background-color:="">源代码细节</h3><h4 style="box-sizing: border-box; outline: 0px; margin: 8px 0px 16px; padding: 0px; font-size: 20px; color: rgb(79, 79, 79); line-height: 28px; word-wrap: break-word; font-family: -apple-system, " sf="" ui="" pingfang="" hiragino="" sans="" microsoft="" wenquanyi="" micro="" font-variant-ligatures:="" white-space:="" background-color:="">数据结构</h4><p style="box-sizing: border-box; outline: 0px; margin-top: 0px; margin-bottom: 16px; padding: 0px; color: rgb(79, 79, 79); line-height: 26px; word-wrap: break-word; font-family: -apple-system, " sf="" ui="" pingfang="" hiragino="" sans="" microsoft="" wenquanyi="" micro="" font-variant-ligatures:="" white-space:="" background-color:="">Fishhook采用链表的方式来存储每一次调用<code style="box-sizing: border-box; outline: 0px; margin: 0px; padding: 2px 4px; font-family: " source="" code="" dejavu="" sans="" ubuntu="" anonymous="" droid="" pingfang="" microsoft="" font-size:="" line-height:="" color:="" background-color:="" border-radius:="" word-wrap:="">rebind_symbols</code>传入的参数，每次调用，就会在链表的头部插入一个节点，链表的头部是：<code style="box-sizing: border-box; outline: 0px; margin: 0px; padding: 2px 4px; font-family: " source="" code="" dejavu="" sans="" ubuntu="" anonymous="" droid="" pingfang="" microsoft="" font-size:="" line-height:="" color:="" background-color:="" border-radius:="" word-wrap:="">_rebindings_head</code>。</p><p><code style="box-sizing: border-box; outline: 0px; margin: 0px; padding: 2px 4px; font-family: " source="" code="" dejavu="" sans="" ubuntu="" anonymous="" droid="" pingfang="" microsoft="" font-size:="" line-height:="" color:="" background-color:="" border-radius:="" word-wrap:="" font-variant-ligatures:="" white-space:="">_rebindings_head->next</code><span style="color: rgb(153, 153, 153); font-family: -apple-system, " sf="" ui="" pingfang="" hiragino="" sans="" microsoft="" wenquanyi="" micro="" font-size:="" font-variant-ligatures:="" white-space:="" background-color:="">就可以判断是否是第一次调用</span><code style="box-sizing: border-box; outline: 0px; margin: 0px; padding: 2px 4px; font-family: " source="" code="" dejavu="" sans="" ubuntu="" anonymous="" droid="" pingfang="" microsoft="" font-size:="" line-height:="" color:="" background-color:="" border-radius:="" word-wrap:="" font-variant-ligatures:="" white-space:="">rebind_symbols</code><span style="color: rgb(153, 153, 153); font-family: -apple-system, " sf="" ui="" pingfang="" hiragino="" sans="" microsoft="" wenquanyi="" micro="" font-size:="" font-variant-ligatures:="" white-space:="" background-color:="">方法。</span><span style="color: rgb(79, 79, 79); font-family: -apple-system, " sf="" ui="" pingfang="" hiragino="" sans="" microsoft="" wenquanyi="" micro="" font-variant-ligatures:="" white-space:="" background-color:=""><br /></span></p></p><section style="color: rgb(62, 62, 62); line-height: 1.6; letter-spacing: 0px; font-family: " helvetica="" hiragino="" sans="" microsoft=""><pre style="font-size: inherit; color: inherit; line-height: inherit; margin-top: 0px; margin-bottom: 0px; padding: 0px;"><code style="margin: 0px 2px; line-height: 18px; font-size: 14px; letter-spacing: 0px; font-family: Consolas, Inconsolata, Courier, monospace; border-radius: 0px; color: rgb(169, 183, 198); background: rgb(40, 43, 46); padding: 0.5em; display: block !important; word-wrap: normal !important; word-break: normal !important; overflow: auto !important;"><span class="hljs-class" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">struct</span>&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(165, 218, 45); word-wrap: inherit !important; word-break: inherit !important;">rebindings_entry</span>&nbsp;{</span><br/>&nbsp;&nbsp;<span class="hljs-class" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">struct</span>&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(165, 218, 45); word-wrap: inherit !important; word-break: inherit !important;">rebinding</span>&nbsp;*<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(165, 218, 45); word-wrap: inherit !important; word-break: inherit !important;">rebindings</span>;</span><br/>&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">size_t</span>&nbsp;rebindings_nel;<br/>&nbsp;&nbsp;<span class="hljs-class" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">struct</span>&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(165, 218, 45); word-wrap: inherit !important; word-break: inherit !important;">rebindings_entry</span>&nbsp;*<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(165, 218, 45); word-wrap: inherit !important; word-break: inherit !important;">next</span>;</span><br/>};<br/></code></pre></section><p><span style="white-space: nowrap;">对外接口</span></p><p><span style="white-space: nowrap;">接着，我们再来看看rebind_symbols这个对外的接口，其中应用到的C函数作用如下：</span></p><ul style="list-style-type: disc;"><li><p><span style="white-space: nowrap;">_dyld_image_count(void) 当前dyld装载的image数量</span></p></li><li><p><span style="white-space: nowrap;">_dyld_get_image_header(unit32_t image_index) 返回image对应的Mach Header地址</span></p></li><li><p><span style="white-space: nowrap;">_dyld_get_image_vmaddr_slide(unit32_t image_index) 虚拟内存中的地址偏移量</span></p></li></ul><p></p><p><span style="color: rgb(79, 79, 79); font-family: -apple-system, " sf="" ui="" pingfang="" hiragino="" sans="" microsoft="" wenquanyi="" micro="" font-variant-ligatures:="" white-space:="" background-color:=""></span></p><section style="color: rgb(62, 62, 62); line-height: 1.6; letter-spacing: 0px; font-family: " helvetica="" hiragino="" sans="" microsoft=""><pre style="font-size: inherit; color: inherit; line-height: inherit; margin-top: 0px; margin-bottom: 0px; padding: 0px;"><code style="margin: 0px 2px; line-height: 18px; font-size: 14px; letter-spacing: 0px; font-family: Consolas, Inconsolata, Courier, monospace; border-radius: 0px; color: rgb(169, 183, 198); background: rgb(40, 43, 46); padding: 0.5em; display: block !important; word-wrap: normal !important; word-break: normal !important; overflow: auto !important;"><span class="hljs-function" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;">int</span>&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(165, 218, 45); word-wrap: inherit !important; word-break: inherit !important;">rebind_symbols</span><span class="hljs-params" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(255, 152, 35); word-wrap: inherit !important; word-break: inherit !important;">(struct&nbsp;rebinding&nbsp;rebindings[],&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">size_t</span>&nbsp;rebindings_nel)</span>&nbsp;</span>{<br/>&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(128, 128, 128); word-wrap: inherit !important; word-break: inherit !important;">//往链表的头部插入一个节点</span><br/>&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">int</span>&nbsp;retval&nbsp;=&nbsp;prepend_rebindings(&_rebindings_head,&nbsp;rebindings,&nbsp;rebindings_nel);<br/>&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">if</span>&nbsp;(retval&nbsp;<&nbsp;<span class="hljs-number" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(174, 135, 250); word-wrap: inherit !important; word-break: inherit !important;">0</span>)&nbsp;{<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(128, 128, 128); word-wrap: inherit !important; word-break: inherit !important;">//插入失败，直接返回</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">return</span>&nbsp;retval;<br/>&nbsp;&nbsp;}<br/>&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">if</span>&nbsp;(!_rebindings_head->next)&nbsp;{<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(128, 128, 128); word-wrap: inherit !important; word-break: inherit !important;">//第一次调用，注册回调方法</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;_dyld_register_func_for_add_image(_rebind_symbols_for_image);<br/>&nbsp;&nbsp;}&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">else</span>&nbsp;{<br/>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(128, 128, 128); word-wrap: inherit !important; word-break: inherit !important;">//遍历已经加载的image，进行实际的hook</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">uint32_t</span>&nbsp;c&nbsp;=&nbsp;_dyld_image_count();<br/>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">for</span>&nbsp;(<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">uint32_t</span>&nbsp;i&nbsp;=&nbsp;<span class="hljs-number" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(174, 135, 250); word-wrap: inherit !important; word-break: inherit !important;">0</span>;&nbsp;i&nbsp;<&nbsp;c;&nbsp;i++)&nbsp;{<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_rebind_symbols_for_image(_dyld_get_image_header(i),&nbsp;_dyld_get_image_vmaddr_slide(i));<br/>&nbsp;&nbsp;&nbsp;&nbsp;}<br/>&nbsp;&nbsp;}<br/>&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">return</span>&nbsp;retval;<br/>}<br/></code></pre></section><h4 style="box-sizing: border-box; outline: 0px; margin: 8px 0px 16px; padding: 0px; font-size: 20px; color: rgb(79, 79, 79); line-height: 28px; word-wrap: break-word; font-family: -apple-system, " sf="" ui="" pingfang="" hiragino="" sans="" microsoft="" wenquanyi="" micro="" font-variant-ligatures:="" white-space:="" background-color:="">具体的Hook过程</h4><ol style="list-style-type: none;"><li style=""><p style="box-sizing: border-box; outline: 0px; margin-top: 0px; margin-bottom: 16px; padding: 0px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; word-wrap: break-word;">1.遍历Load Command，找到<code style="box-sizing: border-box; outline: 0px; margin: 0px; padding: 2px 4px; font-family: " source="" code="" dejavu="" sans="" ubuntu="" anonymous="" droid="" pingfang="" microsoft="" font-size:="" line-height:="" color:="" background-color:="" border-radius:="" word-wrap:="">__LINKEDIT</code>段，indirect symbol table和symbol table</p></li></ol><section style="color: rgb(62, 62, 62); line-height: 1.6; letter-spacing: 0px; font-family: " helvetica="" hiragino="" sans="" microsoft=""><pre style="font-size: inherit; color: inherit; line-height: inherit; margin-top: 0px; margin-bottom: 0px; padding: 0px;"><code style="margin: 0px 2px; line-height: 18px; font-size: 14px; letter-spacing: 0px; font-family: Consolas, Inconsolata, Courier, monospace; border-radius: 0px; color: rgb(169, 183, 198); background: rgb(40, 43, 46); padding: 0.5em; display: block !important; word-wrap: normal !important; word-break: normal !important; overflow: auto !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">segment_command_t</span>&nbsp;*cur_seg_cmd;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(128, 128, 128); word-wrap: inherit !important; word-break: inherit !important;">//当前指针</span><br/><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">segment_command_t</span>&nbsp;*linkedit_segment&nbsp;=&nbsp;<span class="hljs-literal" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(174, 135, 250); word-wrap: inherit !important; word-break: inherit !important;">NULL</span>;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(128, 128, 128); word-wrap: inherit !important; word-break: inherit !important;">//__LINKEDIT段</span><br/><span class="hljs-class" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">struct</span>&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(165, 218, 45); word-wrap: inherit !important; word-break: inherit !important;">symtab_command</span>*&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(165, 218, 45); word-wrap: inherit !important; word-break: inherit !important;">symtab_cmd</span>&nbsp;=&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(165, 218, 45); word-wrap: inherit !important; word-break: inherit !important;">NULL</span>;</span><span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(128, 128, 128); word-wrap: inherit !important; word-break: inherit !important;">//symbol&nbsp;table</span><br/><span class="hljs-class" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">struct</span>&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(165, 218, 45); word-wrap: inherit !important; word-break: inherit !important;">dysymtab_command</span>*&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(165, 218, 45); word-wrap: inherit !important; word-break: inherit !important;">dysymtab_cmd</span>&nbsp;=&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(165, 218, 45); word-wrap: inherit !important; word-break: inherit !important;">NULL</span>;</span><span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(128, 128, 128); word-wrap: inherit !important; word-break: inherit !important;">//indirect&nbsp;symbol&nbsp;table</span><br/><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">uintptr_t</span>&nbsp;cur&nbsp;=&nbsp;(<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">uintptr_t</span>)header&nbsp;+&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">sizeof</span>(<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">mach_header_t</span>);<br/><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">for</span>&nbsp;(uint&nbsp;i&nbsp;=&nbsp;<span class="hljs-number" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(174, 135, 250); word-wrap: inherit !important; word-break: inherit !important;">0</span>;&nbsp;i&nbsp;<&nbsp;header->ncmds;&nbsp;i++,&nbsp;cur&nbsp;+=&nbsp;cur_seg_cmd->cmdsize)&nbsp;{<br/>&nbsp;&nbsp;&nbsp;&nbsp;cur_seg_cmd&nbsp;=&nbsp;(<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">segment_command_t</span>&nbsp;*)cur;<br/>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">if</span>&nbsp;(cur_seg_cmd->cmd&nbsp;==&nbsp;LC_SEGMENT_ARCH_DEPENDENT)&nbsp;{<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(128, 128, 128); word-wrap: inherit !important; word-break: inherit !important;">//找到__LINKEDIT段</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">if</span>&nbsp;(<span class="hljs-built_in" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">strcmp</span>(cur_seg_cmd->segname,&nbsp;SEG_LINKEDIT)&nbsp;==&nbsp;<span class="hljs-number" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(174, 135, 250); word-wrap: inherit !important; word-break: inherit !important;">0</span>)&nbsp;{<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;linkedit_segment&nbsp;=&nbsp;cur_seg_cmd;<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">else</span>&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">if</span>&nbsp;(cur_seg_cmd->cmd&nbsp;==&nbsp;LC_SYMTAB)&nbsp;{<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;symtab_cmd&nbsp;=&nbsp;(struct&nbsp;symtab_command*)cur_seg_cmd;<br/>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">else</span>&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">if</span>&nbsp;(cur_seg_cmd->cmd&nbsp;==&nbsp;LC_DYSYMTAB)&nbsp;{<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dysymtab_cmd&nbsp;=&nbsp;(struct&nbsp;dysymtab_command*)cur_seg_cmd;<br/>&nbsp;&nbsp;&nbsp;&nbsp;}<br/>}<br/></code></pre></section><p><span style="color: rgb(79, 79, 79); font-family: -apple-system, " sf="" ui="" pingfang="" hiragino="" sans="" microsoft="" wenquanyi="" micro="" font-variant-ligatures:="" white-space:="" background-color:="">几个宏定义，可以在</span><code style="box-sizing: border-box; outline: 0px; margin: 0px; padding: 2px 4px; font-family: " source="" code="" dejavu="" sans="" ubuntu="" anonymous="" droid="" pingfang="" microsoft="" font-size:="" line-height:="" color:="" background-color:="" border-radius:="" word-wrap:="" font-variant-ligatures:="" white-space:=""><mach-o loader.h=""></mach-o></code><span style="color: rgb(79, 79, 79); font-family: -apple-system, " sf="" ui="" pingfang="" hiragino="" sans="" microsoft="" wenquanyi="" micro="" font-variant-ligatures:="" white-space:="" background-color:="">中找到</span><span style="color: rgb(79, 79, 79); font-family: -apple-system, " sf="" ui="" pingfang="" hiragino="" sans="" microsoft="" wenquanyi="" micro="" font-variant-ligatures:="" white-space:="" background-color:=""><br /></span></p><p>#define SEG_LINKEDIT “__LINKEDIT” /* the segment containing all structs */&nbsp;</p><p>#define LC_SYMTAB 0x2 /* link-edit stab symbol table info&nbsp;</p><p>#define LC_DYSYMTAB 0xb /* dynamic link-edit symbol table info */</p><p>2.<span style="color: rgb(79, 79, 79); font-family: -apple-system, " sf="" ui="" pingfang="" hiragino="" sans="" microsoft="" wenquanyi="" micro="" font-variant-ligatures:="" white-space:="" background-color:="">找到symbol和string table的base地址</span></p><section style="color: rgb(62, 62, 62); line-height: 1.6; letter-spacing: 0px; font-family: " helvetica="" hiragino="" sans="" microsoft=""><pre style="font-size: inherit; color: inherit; line-height: inherit; margin-top: 0px; margin-bottom: 0px; padding: 0px;"><code style="margin: 0px 2px; line-height: 18px; font-size: 14px; letter-spacing: 0px; font-family: Consolas, Inconsolata, Courier, monospace; border-radius: 0px; color: rgb(169, 183, 198); background: rgb(40, 43, 46); padding: 0.5em; display: block !important; word-wrap: normal !important; word-break: normal !important; overflow: auto !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">uintptr_t</span>&nbsp;linkedit_base&nbsp;=&nbsp;(<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">uintptr_t</span>)slide&nbsp;+&nbsp;linkedit_segment->vmaddr&nbsp;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;linkedit_segment->fileoff;<br/><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">nlist_t</span>&nbsp;*symtab&nbsp;=&nbsp;(<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">nlist_t</span>&nbsp;*)(linkedit_base&nbsp;+&nbsp;symtab_cmd->symoff);<br/><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">char</span>&nbsp;*strtab&nbsp;=&nbsp;(<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">char</span>&nbsp;*)(linkedit_base&nbsp;+&nbsp;symtab_cmd->stroff);<br/></code></pre></section><p>3.<span style="color: rgb(79, 79, 79); font-family: -apple-system, " sf="" ui="" pingfang="" hiragino="" sans="" microsoft="" wenquanyi="" micro="" font-variant-ligatures:="" white-space:="" background-color:="">获取indriect table的数据(uint32_t类型的数组)</span></p><section style="color: rgb(62, 62, 62); line-height: 1.6; letter-spacing: 0px; font-family: " helvetica="" hiragino="" sans="" microsoft=""><pre style="font-size: inherit; color: inherit; line-height: inherit; margin-top: 0px; margin-bottom: 0px; padding: 0px;"><code style="margin: 0px 2px; line-height: 18px; font-size: 14px; letter-spacing: 0px; font-family: Consolas, Inconsolata, Courier, monospace; border-radius: 0px; color: rgb(169, 183, 198); background: rgb(40, 43, 46); padding: 0.5em; display: block !important; word-wrap: normal !important; word-break: normal !important; overflow: auto !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">uint32_t</span>&nbsp;*indirect_symtab&nbsp;=&nbsp;(<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">uint32_t</span>&nbsp;*)(linkedit_base&nbsp;+&nbsp;dysymtab_cmd-&nbsp;&nbsp;>indirectsymoff);<br/></code></pre></section><p>4.<span style="color: rgb(79, 79, 79); font-family: -apple-system, " sf="" ui="" pingfang="" hiragino="" sans="" microsoft="" wenquanyi="" micro="" font-variant-ligatures:="" white-space:="" background-color:="">再一次遍历laod command,这一次遍历</span><code style="box-sizing: border-box; outline: 0px; margin: 0px; padding: 2px 4px; font-family: " source="" code="" dejavu="" sans="" ubuntu="" anonymous="" droid="" pingfang="" microsoft="" font-size:="" line-height:="" color:="" background-color:="" border-radius:="" word-wrap:="" font-variant-ligatures:="" white-space:="">__DATA</code><span style="color: rgb(79, 79, 79); font-family: -apple-system, " sf="" ui="" pingfang="" hiragino="" sans="" microsoft="" wenquanyi="" micro="" font-variant-ligatures:="" white-space:="" background-color:="">段中的Sections,对</span><code style="box-sizing: border-box; outline: 0px; margin: 0px; padding: 2px 4px; font-family: " source="" code="" dejavu="" sans="" ubuntu="" anonymous="" droid="" pingfang="" microsoft="" font-size:="" line-height:="" color:="" background-color:="" border-radius:="" word-wrap:="" font-variant-ligatures:="" white-space:="">S_LAZY_SYMBOL_POINTERS</code><span style="color: rgb(79, 79, 79); font-family: -apple-system, " sf="" ui="" pingfang="" hiragino="" sans="" microsoft="" wenquanyi="" micro="" font-variant-ligatures:="" white-space:="" background-color:="">和</span><code style="box-sizing: border-box; outline: 0px; margin: 0px; padding: 2px 4px; font-family: " source="" code="" dejavu="" sans="" ubuntu="" anonymous="" droid="" pingfang="" microsoft="" font-size:="" line-height:="" color:="" background-color:="" border-radius:="" word-wrap:="" font-variant-ligatures:="" white-space:="">S_NON_LAZY_SYMBOL_POINTERS</code><span style="color: rgb(79, 79, 79); font-family: -apple-system, " sf="" ui="" pingfang="" hiragino="" sans="" microsoft="" wenquanyi="" micro="" font-variant-ligatures:="" white-space:="" background-color:="">段中的指针进行rebin，调用函数</span><code style="box-sizing: border-box; outline: 0px; margin: 0px; padding: 2px 4px; font-family: " source="" code="" dejavu="" sans="" ubuntu="" anonymous="" droid="" pingfang="" microsoft="" font-size:="" line-height:="" color:="" background-color:="" border-radius:="" word-wrap:="" font-variant-ligatures:="" white-space:="">perform_rebinding_with_section</code></p><section style="color: rgb(62, 62, 62); line-height: 1.6; letter-spacing: 0px; font-family: " helvetica="" hiragino="" sans="" microsoft=""><pre style="font-size: inherit; color: inherit; line-height: inherit; margin-top: 0px; margin-bottom: 0px; padding: 0px;"><code style="margin: 0px 2px; line-height: 18px; font-size: 14px; letter-spacing: 0px; font-family: Consolas, Inconsolata, Courier, monospace; border-radius: 0px; color: rgb(169, 183, 198); background: rgb(40, 43, 46); padding: 0.5em; display: block !important; word-wrap: normal !important; word-break: normal !important; overflow: auto !important;">cur&nbsp;=&nbsp;(<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">uintptr_t</span>)header&nbsp;+&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">sizeof</span>(<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">mach_header_t</span>);<br/>&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">for</span>&nbsp;(uint&nbsp;i&nbsp;=&nbsp;<span class="hljs-number" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(174, 135, 250); word-wrap: inherit !important; word-break: inherit !important;">0</span>;&nbsp;i&nbsp;<&nbsp;header->ncmds;&nbsp;i++,&nbsp;cur&nbsp;+=&nbsp;cur_seg_cmd->cmdsize)&nbsp;{<br/>&nbsp;&nbsp;&nbsp;&nbsp;cur_seg_cmd&nbsp;=&nbsp;(<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">segment_command_t</span>&nbsp;*)cur;<br/>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">if</span>&nbsp;(cur_seg_cmd->cmd&nbsp;==&nbsp;LC_SEGMENT_ARCH_DEPENDENT)&nbsp;{<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">if</span>&nbsp;(<span class="hljs-built_in" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">strcmp</span>(cur_seg_cmd->segname,&nbsp;SEG_DATA)&nbsp;!=&nbsp;<span class="hljs-number" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(174, 135, 250); word-wrap: inherit !important; word-break: inherit !important;">0</span>&nbsp;&&<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">strcmp</span>(cur_seg_cmd->segname,&nbsp;SEG_DATA_CONST)&nbsp;!=&nbsp;<span class="hljs-number" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(174, 135, 250); word-wrap: inherit !important; word-break: inherit !important;">0</span>)&nbsp;{<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">continue</span>;<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">for</span>&nbsp;(uint&nbsp;j&nbsp;=&nbsp;<span class="hljs-number" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(174, 135, 250); word-wrap: inherit !important; word-break: inherit !important;">0</span>;&nbsp;j&nbsp;<&nbsp;cur_seg_cmd->nsects;&nbsp;j++)&nbsp;{<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">section_t</span>&nbsp;*sect&nbsp;=<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">section_t</span>&nbsp;*)(cur&nbsp;+&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">sizeof</span>(<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">segment_command_t</span>))&nbsp;+&nbsp;j;<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">if</span>&nbsp;((sect->flags&nbsp;&&nbsp;SECTION_TYPE)&nbsp;==&nbsp;S_LAZY_SYMBOL_POINTERS)&nbsp;{<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;perform_rebinding_with_section(rebindings,&nbsp;sect,&nbsp;slide,&nbsp;symtab,&nbsp;strtab,&nbsp;indirect_symtab);<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">if</span>&nbsp;((sect->flags&nbsp;&&nbsp;SECTION_TYPE)&nbsp;==&nbsp;S_NON_LAZY_SYMBOL_POINTERS)&nbsp;{<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;perform_rebinding_with_section(rebindings,&nbsp;sect,&nbsp;slide,&nbsp;symtab,&nbsp;strtab,&nbsp;indirect_symtab);<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>&nbsp;&nbsp;&nbsp;&nbsp;}<br/>&nbsp;&nbsp;}<br/></code></pre></section><p>5.<span style="box-sizing: border-box; outline: 0px; margin: 0px; padding: 0px; font-weight: 700; word-wrap: break-word; color: rgb(79, 79, 79); font-family: -apple-system, " sf="" ui="" pingfang="" hiragino="" sans="" microsoft="" wenquanyi="" micro="" font-variant-ligatures:="" white-space:="" background-color:=""><code style="box-sizing: border-box; outline: 0px; margin: 0px; padding: 2px 4px; font-family: " source="" code="" dejavu="" sans="" ubuntu="" anonymous="" droid="" pingfang="" microsoft="" font-size:="" line-height:="" color:="" background-color:="" border-radius:="" word-wrap:="">perform_rebinding_with_section</code></span><span style="color: rgb(79, 79, 79); font-family: -apple-system, " sf="" ui="" pingfang="" hiragino="" sans="" microsoft="" wenquanyi="" micro="" font-variant-ligatures:="" white-space:="" background-color:="">，进行section中的symbol rebind。</span></p><section style="color: rgb(62, 62, 62); line-height: 1.6; letter-spacing: 0px; font-family: " helvetica="" hiragino="" sans="" microsoft=""><pre style="font-size: inherit; color: inherit; line-height: inherit; margin-top: 0px; margin-bottom: 0px; padding: 0px;"><code style="margin: 0px 2px; line-height: 18px; font-size: 14px; letter-spacing: 0px; font-family: Consolas, Inconsolata, Courier, monospace; border-radius: 0px; color: rgb(169, 183, 198); background: rgb(40, 43, 46); padding: 0.5em; display: block !important; word-wrap: normal !important; word-break: normal !important; overflow: auto !important;"><span class="hljs-class" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">struct</span>&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(165, 218, 45); word-wrap: inherit !important; word-break: inherit !important;">section</span>&nbsp;{</span>&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(128, 128, 128); word-wrap: inherit !important; word-break: inherit !important;">/*&nbsp;for&nbsp;32-bit&nbsp;architectures&nbsp;*/</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">char</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sectname[<span class="hljs-number" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(174, 135, 250); word-wrap: inherit !important; word-break: inherit !important;">16</span>];&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(128, 128, 128); word-wrap: inherit !important; word-break: inherit !important;">/*&nbsp;name&nbsp;of&nbsp;this&nbsp;section&nbsp;*/</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">char</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;segname[<span class="hljs-number" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(174, 135, 250); word-wrap: inherit !important; word-break: inherit !important;">16</span>];&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(128, 128, 128); word-wrap: inherit !important; word-break: inherit !important;">/*&nbsp;segment&nbsp;this&nbsp;section&nbsp;goes&nbsp;in&nbsp;*/</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">uint32_t</span>&nbsp;&nbsp;&nbsp;&nbsp;addr;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(128, 128, 128); word-wrap: inherit !important; word-break: inherit !important;">/*&nbsp;memory&nbsp;address&nbsp;of&nbsp;this&nbsp;section&nbsp;*/</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">uint32_t</span>&nbsp;&nbsp;&nbsp;&nbsp;size;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(128, 128, 128); word-wrap: inherit !important; word-break: inherit !important;">/*&nbsp;size&nbsp;in&nbsp;bytes&nbsp;of&nbsp;this&nbsp;section&nbsp;*/</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">uint32_t</span>&nbsp;&nbsp;&nbsp;&nbsp;offset;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(128, 128, 128); word-wrap: inherit !important; word-break: inherit !important;">/*&nbsp;file&nbsp;offset&nbsp;of&nbsp;this&nbsp;section&nbsp;*/</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">uint32_t</span>&nbsp;&nbsp;&nbsp;&nbsp;align;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(128, 128, 128); word-wrap: inherit !important; word-break: inherit !important;">/*&nbsp;section&nbsp;alignment&nbsp;(power&nbsp;of&nbsp;2)&nbsp;*/</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">uint32_t</span>&nbsp;&nbsp;&nbsp;&nbsp;reloff;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(128, 128, 128); word-wrap: inherit !important; word-break: inherit !important;">/*&nbsp;file&nbsp;offset&nbsp;of&nbsp;relocation&nbsp;entries&nbsp;*/</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">uint32_t</span>&nbsp;&nbsp;&nbsp;&nbsp;nreloc;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(128, 128, 128); word-wrap: inherit !important; word-break: inherit !important;">/*&nbsp;number&nbsp;of&nbsp;relocation&nbsp;entries&nbsp;*/</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">uint32_t</span>&nbsp;&nbsp;&nbsp;&nbsp;flags;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(128, 128, 128); word-wrap: inherit !important; word-break: inherit !important;">/*&nbsp;flags&nbsp;(section&nbsp;type&nbsp;and&nbsp;attributes)*/</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">uint32_t</span>&nbsp;&nbsp;&nbsp;&nbsp;reserved1;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(128, 128, 128); word-wrap: inherit !important; word-break: inherit !important;">/*&nbsp;reserved&nbsp;(for&nbsp;offset&nbsp;or&nbsp;index)&nbsp;*/</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">uint32_t</span>&nbsp;&nbsp;&nbsp;&nbsp;reserved2;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(128, 128, 128); word-wrap: inherit !important; word-break: inherit !important;">/*&nbsp;reserved&nbsp;(for&nbsp;count&nbsp;or&nbsp;sizeof)&nbsp;*/</span><br/>};<br/></code></pre><p>0</section><h2 style="box-sizing: border-box; outline: 0px; margin: 8px 0px 16px; padding: 0px; font-size: 24px; color: rgb(79, 79, 79); line-height: 32px; word-wrap: break-word; font-family: -apple-system, " sf="" ui="" pingfang="" hiragino="" sans="" microsoft="" wenquanyi="" micro="" font-variant-ligatures:="" white-space:="" background-color:="">局限性</h2><p style="box-sizing: border-box; outline: 0px; margin-top: 0px; margin-bottom: 16px; padding: 0px; color: rgb(79, 79, 79); line-height: 26px; word-wrap: break-word; font-family: -apple-system, " sf="" ui="" pingfang="" hiragino="" sans="" microsoft="" wenquanyi="" micro="" font-variant-ligatures:="" white-space:="" background-color:="">Fishhook能够工作的原理还是PIC(Position Independ Code)，从dyld的角度来说，就是mach-o外部符号（像printf引用其他动态库）绑定的过程。对于内部符号，fishhook是无法进行hook的。</p><p style="box-sizing: border-box; outline: 0px; margin-top: 0px; margin-bottom: 16px; padding: 0px; color: rgb(79, 79, 79); line-height: 26px; word-wrap: break-word; font-family: -apple-system, " sf="" ui="" pingfang="" hiragino="" sans="" microsoft="" wenquanyi="" micro="" font-variant-ligatures:="" white-space:="" background-color:="">比如，我们在代码里写一个C函数，</p><section style="color: rgb(62, 62, 62); line-height: 1.6; letter-spacing: 0px; font-family: " helvetica="" hiragino="" sans="" microsoft=""><pre style="font-size: inherit; color: inherit; line-height: inherit; margin-top: 0px; margin-bottom: 0px; padding: 0px;"><code style="margin: 0px 2px; line-height: 18px; font-size: 14px; letter-spacing: 0px; font-family: Consolas, Inconsolata, Courier, monospace; border-radius: 0px; color: rgb(169, 183, 198); background: rgb(40, 43, 46); padding: 0.5em; display: block !important; word-wrap: normal !important; word-break: normal !important; overflow: auto !important;"><span class="hljs-class" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">struct</span>&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(165, 218, 45); word-wrap: inherit !important; word-break: inherit !important;">section</span>&nbsp;{</span>&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(128, 128, 128); word-wrap: inherit !important; word-break: inherit !important;">/*&nbsp;for&nbsp;32-bit&nbsp;architectures&nbsp;*/</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">char</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sectname[<span class="hljs-number" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(174, 135, 250); word-wrap: inherit !important; word-break: inherit !important;">16</span>];&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(128, 128, 128); word-wrap: inherit !important; word-break: inherit !important;">/*&nbsp;name&nbsp;of&nbsp;this&nbsp;section&nbsp;*/</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">char</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;segname[<span class="hljs-number" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(174, 135, 250); word-wrap: inherit !important; word-break: inherit !important;">16</span>];&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(128, 128, 128); word-wrap: inherit !important; word-break: inherit !important;">/*&nbsp;segment&nbsp;this&nbsp;section&nbsp;goes&nbsp;in&nbsp;*/</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">uint32_t</span>&nbsp;&nbsp;&nbsp;&nbsp;addr;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(128, 128, 128); word-wrap: inherit !important; word-break: inherit !important;">/*&nbsp;memory&nbsp;address&nbsp;of&nbsp;this&nbsp;section&nbsp;*/</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">uint32_t</span>&nbsp;&nbsp;&nbsp;&nbsp;size;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(128, 128, 128); word-wrap: inherit !important; word-break: inherit !important;">/*&nbsp;size&nbsp;in&nbsp;bytes&nbsp;of&nbsp;this&nbsp;section&nbsp;*/</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">uint32_t</span>&nbsp;&nbsp;&nbsp;&nbsp;offset;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(128, 128, 128); word-wrap: inherit !important; word-break: inherit !important;">/*&nbsp;file&nbsp;offset&nbsp;of&nbsp;this&nbsp;section&nbsp;*/</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">uint32_t</span>&nbsp;&nbsp;&nbsp;&nbsp;align;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(128, 128, 128); word-wrap: inherit !important; word-break: inherit !important;">/*&nbsp;section&nbsp;alignment&nbsp;(power&nbsp;of&nbsp;2)&nbsp;*/</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">uint32_t</span>&nbsp;&nbsp;&nbsp;&nbsp;reloff;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(128, 128, 128); word-wrap: inherit !important; word-break: inherit !important;">/*&nbsp;file&nbsp;offset&nbsp;of&nbsp;relocation&nbsp;entries&nbsp;*/</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">uint32_t</span>&nbsp;&nbsp;&nbsp;&nbsp;nreloc;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(128, 128, 128); word-wrap: inherit !important; word-break: inherit !important;">/*&nbsp;number&nbsp;of&nbsp;relocation&nbsp;entries&nbsp;*/</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">uint32_t</span>&nbsp;&nbsp;&nbsp;&nbsp;flags;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(128, 128, 128); word-wrap: inherit !important; word-break: inherit !important;">/*&nbsp;flags&nbsp;(section&nbsp;type&nbsp;and&nbsp;attributes)*/</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">uint32_t</span>&nbsp;&nbsp;&nbsp;&nbsp;reserved1;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(128, 128, 128); word-wrap: inherit !important; word-break: inherit !important;">/*&nbsp;reserved&nbsp;(for&nbsp;offset&nbsp;or&nbsp;index)&nbsp;*/</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(248, 35, 117); word-wrap: inherit !important; word-break: inherit !important;">uint32_t</span>&nbsp;&nbsp;&nbsp;&nbsp;reserved2;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(128, 128, 128); word-wrap: inherit !important; word-break: inherit !important;">/*&nbsp;reserved&nbsp;(for&nbsp;count&nbsp;or&nbsp;sizeof)&nbsp;*/</span><br/>};<br/></code></pre><p>1</section><p><span style="color: rgb(79, 79, 79); font-family: -apple-system, " sf="" ui="" pingfang="" hiragino="" sans="" microsoft="" wenquanyi="" micro="" font-variant-ligatures:="" white-space:="" background-color:="">然后，编译，用MachOView打开可执行文件，发现不管是lazy还是non lazy的symbols里，都没有这个</span><code style="box-sizing: border-box; outline: 0px; margin: 0px; padding: 2px 4px; font-family: " source="" code="" dejavu="" sans="" ubuntu="" anonymous="" droid="" pingfang="" microsoft="" font-size:="" line-height:="" color:="" background-color:="" border-radius:="" word-wrap:="" font-variant-ligatures:="" white-space:="">LeoTestCFunction</code><span style="color: rgb(79, 79, 79); font-family: -apple-system, " sf="" ui="" pingfang="" hiragino="" sans="" microsoft="" wenquanyi="" micro="" font-variant-ligatures:="" white-space:="" background-color:="">符号。</span></p><p><img data-original="https://img-blog.csdn.net/20171103121106950?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvSGVsbG9fSHdj/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" src="https://blog.isoyu.com/wp-content/themes/INSO/images/post_loading.gif" style="box-sizing: border-box; outline: 0px; margin: 24px 0px; padding: 0px; border-style: none; max-width: 100%; word-wrap: break-word; cursor: zoom-in; color: rgb(79, 79, 79); font-family: -apple-system, " sf="" ui="" pingfang="" hiragino="" sans="" microsoft="" wenquanyi="" micro="" font-variant-ligatures:="" white-space:="" background-color:=""/></p><p><span style="color: rgb(79, 79, 79); font-family: -apple-system, " sf="" ui="" pingfang="" hiragino="" sans="" microsoft="" wenquanyi="" micro="" font-variant-ligatures:="" white-space:="" background-color:="">原因也很简单</span></p><p>LeoTestCFunction是内部函数，编译后，函数的实现会在mach-o的__TEXT（代码段）里。编译后，当前调用处的指针，是直接指向代码段中的地址的。这个地址是由mach-o的base+offset获得的，其中offset是一定的。dyld在装载的时候，只需要对这些符号进行rebase即可（修改地址为newbae+offset）。</p><p>---------------------&nbsp;</p><p>作者：黄文臣&nbsp;</p><p>原文：https://blog.csdn.net/Hello_Hwc/article/details/78444203&nbsp;</p><div style="float:right;"><a target="_blank" title="点击查看" rel="external nofollow" href="https://blog.isoyu.com/go.php?url=http://www.baidu.com/s?wd=Fishhook替换C函数的原理"  rel="nofollow" >百度已收录</a></div></div></div><section class="pagination"></section><section class="post-social"><div class="post-like"> <a href="#" data-post_id="5790" title="喜欢该文章，请点赞！"><i class="icon-thumbs-up">赞</i>(<span class="count">0</span>)</a></div><div class="rewards"><a class="btn" href="#pay" title="觉得文章有用请给小姬姬打赏！"> 赏 </a></div><div class="share"> <span><i class="icon-share"></i>分享</span><div class="share_btn"> <a target="_blank" target="_blank" href="https://service.weibo.com/share/share.php?url=https://blog.isoyu.com/archives/fishhooktihuanchanshudeyuanli.html&amp;title=【Fishhook替换C函数的原理】FishhookFishhook是facebook出品的，可以用来Hook C函数的一个开源库。它的主要接口就一个：struct&n&hellip;&nbsp;@姬長信&amp;appkey=&amp;pic=&amp;searchPic=true" title="分享到新浪微博" class="weibo" rel="nofollow"><i class="icon-weibo"></i></a> <a target="_blank" href="https://connect.qq.com/widget/shareqq/index.html?url=https://blog.isoyu.com/archives/fishhooktihuanchanshudeyuanli.html&title=Fishhook替换C函数的原理&desc=&summary=FishhookFishhook是facebook出品的，可以用来Hook C函数的一个开源库。它的主要接口就一个：struct&nbsp;rebinding&nbsp;{&nbsp;&nbsp;const&nbsp;char&nb&hellip;&site=姬長信" title="分享到QQ好友" class="qq" rel="nofollow"><i class="icon-qq"></i></a> <a target="_blank" href="https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=https://blog.isoyu.com/archives/fishhooktihuanchanshudeyuanli.html&title=Fishhook替换C函数的原理&desc=&summary=FishhookFishhook是facebook出品的，可以用来Hook C函数的一个开源库。它的主要接口就一个：struct&nbsp;rebinding&nbsp;{&nbsp;&nbsp;const&nbsp;char&nb&hellip;&site=姬長信" title="分享到QQ空间" class="qqzone" rel="nofollow"><i class="icon-qzone"></i></a></div></div></section><section class="post_declare"><p> 本文由 <a href="姬長信">投稿者</a> 创作，文章地址：<a href="https://blog.isoyu.com/archives/fishhooktihuanchanshudeyuanli.html">https://blog.isoyu.com/archives/fishhooktihuanchanshudeyuanli.html</a><br>采用<a href="https://creativecommons.org/licenses/by/4.0/" target="_blank" rel="external nofollow">知识共享署名4.0</a> 国际许可协议进行许可。除注明转载/出处外，均为本站原创或翻译，转载前请务必署名。最后编辑时间为:11月 27, 2018 at 07:10 下午</p><div class="tags"></div></section></article><section class="prevnext box triangle"><div class="prev"> <a href="https://blog.isoyu.com/archives/lijie-swift-zhongdeyuanleixing-type-yu-self.html" rel="prev">理解 Swift 中的元类型：.Type 与 .self</a></div><div class="next"> <a href="https://blog.isoyu.com/archives/shenrulijieios-appdeqidongguocheng.html" rel="next">深入理解iOS App的启动过程</a></div></section><section class="related_posts box triangle"><section class="home_title"><h3>相关文章</h3></section><ul class="layout_ul"><li class="layout_li"><article class="postgrid"><figure> <a href="https://blog.isoyu.com/archives/bizhimitangwuzhipishuangliaoliaoruanjiankaifazhongdezuijiashijian.html" title="彼之蜜糖，吾之砒霜——聊聊软件开发中的最佳实践"> <img class="thumb" src="https://blog.isoyu.com/wp-content/themes/INSO/includes/timthumb.php?src=https://blog.isoyu.com/wp-content/themes/INSO/images/thumb_loading.jpg&amp;h=338&amp;w=600" data-original="https://blog.isoyu.com/wp-content/themes/INSO/includes/timthumb.php?src=http://www.techug.com/wordpress/wp-content/uploads/2018/09/788453-20180807222234285-1892228947.png&amp;h=338&amp;w=600" alt="彼之蜜糖，吾之砒霜——聊聊软件开发中的最佳实践" /> </a></figure><h2><a href="https://blog.isoyu.com/archives/bizhimitangwuzhipishuangliaoliaoruanjiankaifazhongdezuijiashijian.html" title="彼之蜜糖，吾之砒霜——聊聊软件开发中的最佳实践">彼之蜜糖，吾之砒霜——聊聊软件开发中的最佳实践</a></h2><div class="homeinfo"> <span class="category"><a href="https://blog.isoyu.com/source-code/" rel="category tag">源码</a></span> <span class="date">2018-09-11</span> <span  title="请先浏览本文章，再确定是否点赞！"class="like"><i class="icon-thumbs-up"></i>0</span></div></article></li><li class="layout_li"><article class="postgrid"><figure> <a href="https://blog.isoyu.com/archives/gongyinglianxiaoxiiphone-se2shoujihuanmeikaishiliangchan.html" title="供应链消息：iPhone SE2手机还没开始量产"> <img class="thumb" src="https://blog.isoyu.com/wp-content/themes/INSO/includes/timthumb.php?src=https://blog.isoyu.com/wp-content/themes/INSO/images/thumb_loading.jpg&amp;h=338&amp;w=600" data-original="https://blog.isoyu.com/wp-content/themes/INSO/includes/timthumb.php?src=http://upload.techweb.com.cn/s/640/2018/0514/1526262789993.jpg&amp;h=338&amp;w=600" alt="供应链消息：iPhone SE2手机还没开始量产" /> </a></figure><h2><a href="https://blog.isoyu.com/archives/gongyinglianxiaoxiiphone-se2shoujihuanmeikaishiliangchan.html" title="供应链消息：iPhone SE2手机还没开始量产">供应链消息：iPhone SE2手机还没开始量产</a></h2><div class="homeinfo"> <span class="category"><a href="https://blog.isoyu.com/source-code/" rel="category tag">源码</a></span> <span class="date">2018-05-14</span> <span  title="请先浏览本文章，再确定是否点赞！"class="like"><i class="icon-thumbs-up"></i>0</span></div></article></li><li class="layout_li"><article class="postgrid"><figure> <a href="https://blog.isoyu.com/archives/dianzihuobi30niancongdianzihuobidaoqukuailian.html" title="电子货币30年：从电子货币到区块链"> <img class="thumb" src="https://blog.isoyu.com/wp-content/themes/INSO/includes/timthumb.php?src=https://blog.isoyu.com/wp-content/themes/INSO/images/thumb_loading.jpg&amp;h=338&amp;w=600" data-original="https://blog.isoyu.com/wp-content/themes/INSO/includes/timthumb.php?src=http://e0.ifengimg.com/05/2018/1206/228B297320CF1D7404D961D19415602C447C97C6_size84_w426_h327.jpeg&amp;h=338&amp;w=600" alt="电子货币30年：从电子货币到区块链" /> </a></figure><h2><a href="https://blog.isoyu.com/archives/dianzihuobi30niancongdianzihuobidaoqukuailian.html" title="电子货币30年：从电子货币到区块链">电子货币30年：从电子货币到区块链</a></h2><div class="homeinfo"> <span class="category"><a href="https://blog.isoyu.com/source-code/" rel="category tag">源码</a></span> <span class="date">2018-12-07</span> <span  title="请先浏览本文章，再确定是否点赞！"class="like"><i class="icon-thumbs-up"></i>0</span></div></article></li></ul></section><section class="hotlike_posts box triangle"><section class="hot"><h3>热评文章</h3><ul class="layout_ul"><li class="layout_li"> <a href="https://blog.isoyu.com/archives/20741.html" title="iPhone X Plus曝光：6.5英寸屏价格破万-ios学习从入门到精通尽在姬长信&nbsp;有(0)条评论"><span>1</span>iPhone X Plus曝光：6.5英寸屏价格破万-ios学习从入门到精通尽在姬长信</a></li><li class="layout_li"> <a href="https://blog.isoyu.com/archives/kukehe-iphone-sheyingshijiebanquwanjuranhuanshiweilepianniduoyong-iphone-paizhao.html" title="库克和 iPhone 摄影师结伴去玩，居然还是为了骗你多用 iPhone 拍照？&nbsp;有(0)条评论"><span>2</span>库克和 iPhone 摄影师结伴去玩，居然还是为了骗你多用 iPhone 拍照？</a></li><li class="layout_li"> <a href="https://blog.isoyu.com/archives/20135.html" title="安卓用户不愿换 iPhone，主要原因是没有耳机插孔-ios学习从入门到精通尽在姬长信&nbsp;有(0)条评论"><span>3</span>安卓用户不愿换 iPhone，主要原因是没有耳机插孔-ios学习从入门到精通尽在姬长信</a></li><li class="layout_li"> <a href="https://blog.isoyu.com/archives/shamoluotuo.html" title="沙漠骆驼&nbsp;有(0)条评论"><span>4</span>沙漠骆驼</a></li><li class="layout_li"> <a href="https://blog.isoyu.com/archives/liulang.html" title="流浪&nbsp;有(0)条评论"><span>5</span>流浪</a></li></ul></section><section class="like"><h3>最赞的文章</h3><ul class="layout_ul"><li class="layout_li"> <a href="https://blog.isoyu.com/archives/20135.html" title="安卓用户不愿换 iPhone，主要原因是没有耳机插孔-ios学习从入门到精通尽在姬长信&nbsp;有(6)人点赞"><span>1</span>安卓用户不愿换 iPhone，主要原因是没有耳机插孔-ios学习从入门到精通尽在姬长信</a></li><li class="layout_li"> <a href="https://blog.isoyu.com/archives/chengxuyuansuanfajichudongtaiguihua.html" title="程序员算法基础——动态规划&nbsp;有(5)人点赞"><span>2</span>程序员算法基础——动态规划</a></li><li class="layout_li"> <a href="https://blog.isoyu.com/archives/shirenyouqingshi-chengxuyuanyouqingma.html" title="诗人有情诗 程序员有情码&nbsp;有(4)人点赞"><span>3</span>诗人有情诗 程序员有情码</a></li><li class="layout_li"> <a href="https://blog.isoyu.com/archives/shamoluotuo.html" title="沙漠骆驼&nbsp;有(3)人点赞"><span>4</span>沙漠骆驼</a></li><li class="layout_li"> <a href="https://blog.isoyu.com/archives/shuoshuren.html" title="说书人&nbsp;有(22)人点赞"><span>5</span>说书人</a></li></ul></section></section><div id="comments" class="box triangle"><div id="respond" class="comment-respond"><h3 id="reply-title" class="comment-reply-title">发表评论 <small><a rel="nofollow" id="cancel-comment-reply-link" href="/archives/fishhooktihuanchanshudeyuanli.html#respond" style="display:none;">取消回复</a></small></h3><form action="https://blog.isoyu.com/wp-comments-post.php" method="post" id="commentform" class="comment-form"><p class="comment-notes"></p><p class="comment-form-comment"><label for="comment"></label><textarea id="comment" name="comment" placeholder="欢迎您在这里留下评论，评论需经人工审核，请您文明上网、理性发言并遵守相关规定" cols="45" rows="8" aria-required="true"></textarea></p><p class="comment-form-author"><label for="author">称呼</label> <span class="required">[必填]</span><input type="text" value="游客" placeholder="请输入您的姓名" aria-required="true" size="30" value="" name="author" id="author"></p><p class="comment-form-email"><label for="email">邮箱</label> <span class="required">[必填]</span><input type="text" value="@qq.com" placeholder="请输入您的邮箱" aria-required="true" size="30" value="" name="email" id="email"></p><p class="comment-form-url"><label for="url">网站(选填)</label><input type="text" placeholder="https://" size="30" value="" name="url" id="url"></p> <label for="chinese_captcha">请输入</label> <input id="chicha" type="text" name="chicha" value="" size="4" maxlength="3"/> <img id="chinesecaptcha" src="" title="请输入图中两个独立的汉字"/> <a rel="nofollow" href="javascript:ReChicha();" title="刷新验证码">看不清？</a><script language="javascript" type="text/javascript">document.getElementById("chinesecaptcha").src ="https://blog.isoyu.com/wp-content/plugins/chinese-captcha/chicha.php?" + Math.random();
function ReChicha(){
  document.getElementById("chinesecaptcha").src ="https://blog.isoyu.com/wp-content/plugins/chinese-captcha/chicha.php?" + Math.random();
}</script><p class="form-submit"><input name="submit" type="submit" id="submit" class="submit" value="发表评论" /> <input type='hidden' name='comment_post_ID' value='5790' id='comment_post_ID' /> <input type='hidden' name='comment_parent' id='comment_parent' value='0' /></p>提交后请等待三秒以免造成未提交成功和重复<br><input type="checkbox" name="comment_mail_notify" id="comment_mail_notify" value="comment_mail_notify" checked="checked" style="margin-left:0px;" /><label id="comment_mail_title" for="comment_mail_notify">有人回复时邮件通知我</label></form></div></div></section></section></section><footer class="footer">  <script>jQuery(function(){  
        $(".comment-body").hover(function(){  
            $(this).find(".ua-info").toggle();  
        },function(){  
            $(this).find(".ua-info").toggle();  
        });  
    });</script> <section class="copyright"><p> Copyright © 2012-2019 <a href="//blog.isoyu.com/">BLOG.ISOYU.COM</a> <a href="//blog.isoyu.com/sitemap.xml">Sitemap</a> <a href="https://blog.isoyu.com/amp-sitemap.html">AMP Sitemap</a><br> 由<a target="_blank" href="http://typecho.org">Typecho</a> 强力驱动.Theme is <a target="_blank" href="https://github.com/insoxin/Musik-for-Typecho">Musik</a><a target="_blank" href="https://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&email=2_ri6e3t7ejs45uqqvW4tLY" style="text-decoration:none;"><img src="https://rescdn.qqmail.com/zh_CN/htmledition/images/function/qm_open/ico_mailme_12.png"/></a><script>(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();</script> </p></section><section class="insoxintheme"> &nbsp;<span><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?8a3917c19e17e63c5511d56e87659b22";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script> <script>(function(){
var src = (document.location.protocol == "http:") ? "http://js.passport.qihucdn.com/11.0.1.js?82309d8c6ba8224b7907b52a203e055d":"https://jspassport.ssl.qhimg.com/11.0.1.js?82309d8c6ba8224b7907b52a203e055d";
document.write('<script src="' + src + '" id="sozz"></script>');
})(); </script></span></section><section class="footer-popup"> <a class="side_btn show"><i class="icon-lock"></i></a> <a class="side_btn search" href="#search" title="点击按钮进行搜索"><i class="icon-search-1"></i></a> <a class="side_btn weibo" href="http://weibo.com/3461828744" title="新浪微博" target="_blank"><i class="icon-weibo"></i></a> <a name="gb2big5" id="gb2big5" class="side_btn gb2big5" title="简繁切换"> 简 </a> <a class="side_btn top" id="back-to-top" href="#top" title="返回顶部"><i class="icon-flight"></i></a> <a id="search" class="overlay" href="#nl"></a><article class="search popup"><h3><i class="icon-search-1"></i> 按文章类型进行搜索</h3><form method="get" class="search_form" action="https://blog.isoyu.com"> <select name="post_type" class="search_type"><option value="post"> 文章</option><option value="gallery"> 画廊</option><option value="video"> 视频</option> </select> <input class="text_input" type="text" placeholder="输入关键字…" name="s" id="s" /> <input type="submit" class="search_btn" id="searchsubmit" value="搜索" /></form></article> <a href="#thanks" class="overlay" id="pay"></a><article class="pay popup"><h3> 觉得文章有用可以给小姬姬打赏哦！</h3> <span><img src="https://api.isoyu.com/pay/zfbpay.png" alt="支付宝收款二维码"><i>支付宝扫一扫打赏</i></span> <span><img src="https://api.isoyu.com/pay/wechatpay.png" alt="微信收款二维码"><i>微信扫一扫打赏</i></span></article> <a href="#thanks" class="overlay" id="pay"></a><article class="pay popup"><h3> 觉得文章有用可以给小姬姬打赏哦！</h3> <span><img src="https://api.isoyu.com/pay/zfbpay.png" alt="支付宝收款二维码"><i>支付宝扫一扫打赏</i></span> <span><img src="https://api.isoyu.com/pay/wechatpay.png" alt="微信收款二维码"><i>微信扫一扫打赏</i></span></article></section></footer></section><script type='text/javascript'>/* <![CDATA[ */ var ajax_var = {"url":"https:\/\/blog.isoyu.com\/wp-admin\/admin-ajax.php","nonce":"7e9565762a"}; /* ]]> */</script> <script type='text/javascript'>/* <![CDATA[ */ var ajaxcomment = {"ajax_url":"https:\/\/blog.isoyu.com\/wp-admin\/admin-ajax.php","order":"desc","formpostion":"bottom"}; /* ]]> */</script>  <script src="https://blog.isoyu.com/wp-content/cache/min/1/e080d860ed0cea103cfa78e67f479800.js" data-minify="1"></script></body></html>
<!-- 查看源代码的这位朋友 如果遇到困难可以在博客留言，姬长信https://blog.isoyu.com，很乐意能帮到您! - 这个页面最后变动时间戳是:1551159453 -->